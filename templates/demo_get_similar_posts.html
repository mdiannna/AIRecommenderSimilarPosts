{% extends 'base.html' %}

{% block title %}Index Page{% endblock %}

{% block styles%}
<style>
/*
*
* ==========================================
* CUSTOM UTIL CLASSES
* ==========================================
*
*/
.upload-input {
    opacity: 0;
}

#upload-label, #upload-label2 {
    position: absolute;
    top: 50%;
    left: 1rem;
    transform: translateY(-50%);
}

.image-area {
    border: 2px dashed rgba(255, 255, 255, 0.7);
    padding: 1rem;
    position: relative;
}

.image-area::before {
    content: 'Uploaded image result';
    color: #fff;
    font-weight: bold;
    text-transform: uppercase;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.8rem;
    z-index: 1;
}

.image-area img {
    z-index: 2;
    position: relative;
}
</style>
{% endblock %}

{% block body %}

<h1 class="ui header text-center mb-4">Get similar posts for a post demo</h1>
<!-- <p>Upload image, write text, click "Post"!</p> -->


<form id="imgSimForm" action="/api/get-similar-posts" enctype=multipart/form-data>
    <div class="row">
        <div class="col-lg-4 mx-auto text-center">
            
            <div class="input-group">
            <select class="select custom-select">
            {% for post in demo_posts %}
                <option value="{{post.id}}">{{post.post_id_external}} : {{post.text[:10]}}</option>
            {% endfor %}
            </select>
        </div>


        <div class="image-area mt-4">
            <img id="postImg" src="#" alt="" class="img-fluid rounded shadow-sm mx-auto d-block">
        </div>

        <div id="postTxt">

        </div>
        <div id="postFields">

        </div>




            <!-- {% for post in demo_posts %}
            <p>id: {{ post.id}}</p>
            <p>img path: {{post.img_path}}</p>
            <img src="{{post.img_path}}" class="img-responsive img img-fluid">
            <p>text: {{post.text}}</p>
            <p>fields: {{post.fields}}</p>
            {% endfor %} -->


            </div>
    </div>
    <div class="row">
        
        <div class="col-lg-4 mx-auto text-center">

            <button type="submit" class="btn btn-success ">Get similar posts</button>

        </div>
    </div>

</form>


<div id="results">


<!-- <hr> -->
<!-- <h1 class="ui header">{{ greetings }}</h1> -->

{% endblock %}

{% block scripts %}
<script>


$('select').on('change', function() {
    var selected_post_id = this.value;
    console.log("selected post with id:", selected_post_id);
    // console.log("{{demo_posts }}".replaceAll("&#39;", '"'));
    var demo_posts = JSON.parse("{{demo_posts }}".replaceAll("&#39;", '"'));

    // console.log("demo_posts", demo_posts);

    var selected_post = demo_posts.filter(obj => {
        return obj.id === selected_post_id
    })[0];


    console.log("selected post:", selected_post);
    console.log("img path:", selected_post.img_path);

    $("#postImg").attr("src", selected_post.img_path);
    $("#postTxt").html("<p><b>text:</b> " + selected_post.text+ "</p>");
    console.log("fields:", selected_post.fields);
    $("#postFields").html("<p><b>fields:</b> " + JSON.stringify(selected_post.fields) + "</p>");



//   alert( this.value );
});



function showSimilarImgs(image_paths, image_ids, scores_res) {
        console.log("show imgs", image_ids.length);
        for (var i=0; i<image_ids.length; i++) {
            $('#results').append('<img class="img img-responsive img-fluid"  style="width:13%" src="' + image_paths[i]+'" />');
            // $('#results').append('<span>' + image_ids[i] + '</span>');
            $('#results').append('<span>score: ' + scores_res[image_ids[i]] + '</span>');

        }

    }



$( "#imgSimForm" ).submit(function( event ) {
    
    // Stop form from submitting normally
    event.preventDefault();
    
    // Get some values from elements on the page:
    var $form = $( this );
    // var text = $form.find( "textarea[name='post_text']" ).val();
    // var img_path1= infoArea.textContent;

    console.log("files:", input.files[0]);
    var url = $form.attr( "action" );


    var formData = new FormData();

    // // add assoc key values, this will be posts values
    formData.append("image", input.files[0], input.files[0].name);

    formData.append("upload_file", true);
    formData.append("include_paths", true);

    // data ={"token": "test-demo", "text": text};
    // var formData = data;
    // var posting = $.post( url, formData, contentType=false, processData=false );

    $("#results").html("Loading... wait please");

    var token = "{{token}}";    
    // console.log(token);

    $.ajaxSetup({
        headers: {
            'Authorization' : "Bearer {{token}}"
        }
    });


        
    $.ajax({
        type: "POST",
        url: url,
        success: function (data) {
            $("#results").html("***succes - " + data + "\n similarity_score:", data.similarity_score);

            console.log("succes:", data);
            console.log("results:", data.results);
            var results = data.results;
            // console.log(results.length);
            console.log(Object.keys(results));

            
            for(var i=0; i<results.length; i++){
                console.log(results[i]);
            }

            var image_paths = Object.values(data.img_paths_map);
            var image_ids = Object.keys(data.img_paths_map)
            var scores = data.results;


            console.log("img paths map", data.img_paths_map);
            console.log('image paths only:', image_paths);

            // console.log("data sim:", data.similarity_score)
            // console.log("succes:" + data.data);          

            // $("#results").html("Similarity score: " + data.similarity_score);
            // $("#results").html("Response " + data);
            $("#results").html("<p>Succes. Similar images:</p>");
            showSimilarImgs(image_paths, image_ids, scores);

        },
        error: function (xhr, status, error) {
            var err = eval("(" + xhr.responseText + ")");
            // alert("Error. " + err.message);
            $("#results").html("***error: "+error + ". <br>Message: " +  err.message);
            console.log("error:", error);

        },
        async: true,
        data: formData,
        cache: false,
        contentType: false,
        processData: false,
        // timeout: 60000
    });

   
});

</script>
{% endblock %}